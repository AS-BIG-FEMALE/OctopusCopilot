<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Octopus Copilot</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/event-source-polyfill@1.0.31/src/eventsource.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<nav class="navbar mb-4 navbar-dark" style="background-color: #0D80D8;">
    <span class="navbar-brand text-center col-12 h1">Octopus Copilot</span>
</nav>
<form>
    <div class="form-group row">
        <label for="token" class="col-2 offset-2 col-form-label">GitHub Token</label>
        <div class="col-6">
            <input id="token" name="token" type="password" class="form-control">
            <small id="tokenHelp" class="form-text text-muted">This is a GitHub <a
                    href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens">Personal
                Access Token (PAT)</a>. It emulates the token that Copilot would normally send.</small>
        </div>
    </div>
    <div class="form-group row">
        <label for="query" class="col-2 offset-2 col-form-label">Query</label>
        <div class="col-6">
            <input id="query" name="query" type="text" class="form-control">
            <small id="queryHelp" class="form-text text-muted">This is a plain text query. Ask something like "Show me
                the projects in the Default space".</small>
        </div>
    </div>
    <div class="form-group row">
        <div class="offset-4 col-8">
            <button id="submit" name="submit" type="button" class="btn btn-primary">Submit</button>
        </div>
    </div>
    <div class="form-group row">
        <label class="col-2 offset-2 col-form-label">Response</label>
        <div class="col-6">
            <div id="markdown"></div>
        </div>
    </div>
</form>
</body>
<script>
    async function processQuery() {
        markdown.innerHTML = "Processing..."
        query.disabled = true
        submit.disabled = true
        token.disabled = true

        function enableInput() {
            query.disabled = false
            submit.disabled = false
            token.disabled = false
        }

        // Use the polyfill to get the ability to send headers.
        var evtSource = new EventSourcePolyfill('/api/form_handler?message=' + encodeURIComponent(query.value), {
            headers: {
                'X-GitHub-Token': token.value
            }
        });

        let response = ""
        evtSource.onmessage = (event) => {
            console.log(event)
            evtSource.close()
            response += event.data + "\n"
            markdown.innerHTML = marked.parse(response);
            enableInput()
        };
        evtSource.onerror = (event) => {
            console.log(event)
            evtSource.close()
            markdown.innerHTML = "The request resulted in an error."
            enableInput()
        };
    }

    submit.onclick = processQuery
    query.addEventListener("keydown", function (e) {
        if (e.code === "Enter") {
            processQuery()
        }
    });
</script>
</html>
