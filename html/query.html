<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Octopus Copilot</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/event-source-polyfill@1.0.31/src/eventsource.min.js"></script>
</head>
<body class="m-3">
<form>
    <div class="form-group row">
        <label for="api" class="col-2 offset-2 col-form-label">GitHub Token</label>
        <div class="col-6">
            <input id="token" name="token" type="password" class="form-control">
        </div>
    </div>
    <div class="form-group row">
        <label for="api" class="col-2 offset-2 col-form-label">Octopus API Key</label>
        <div class="col-6">
            <input id="api" name="token" type="password" class="form-control">
        </div>
    </div>
    <div class="form-group row">
        <label for="query" class="col-2 offset-2 col-form-label">Query</label>
        <div class="col-6">
            <input id="query" name="query" type="text" class="form-control">
        </div>
    </div>
    <div class="form-group row">
        <div class="offset-4 col-8">
            <button id="submit" name="submit" type="button" class="btn btn-primary">Submit</button>
        </div>
    </div>
    <div class="form-group row">
        <label class="col-2 offset-2 col-form-label" for="textarea">Response</label>
        <div class="col-6">
            <textarea readonly id="textarea" name="textarea" cols="40" rows="5" class="form-control"></textarea>
        </div>
    </div>
</form>
</body>
<script>
    async function processQuery() {
        textarea.value = "Processing..."

        // Use the polyfill to get the ability to send headers.
        var evtSource = new EventSourcePolyfill('/api/form_handler?message=' + encodeURIComponent(query.value), {
            headers: {
                'X-GitHub-Token': token.value,
                'OCTOPUS_API': api.value
            }
        });

        let response = ""
        evtSource.onmessage = (event) => {
            console.log(event)
            evtSource.close()
            response += event.data + "\n"
            textarea.value = response
        };
        evtSource.onerror = (event) => {
            console.log(event)
            evtSource.close()
            textarea.value = "The request resulted in an error"
        };
    }

    submit.onclick = processQuery
    query.addEventListener("keydown", function (e) {
        if (e.code === "Enter") {
            processQuery()
        }
    });
</script>
</html>
